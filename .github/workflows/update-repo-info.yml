name: Update Repository Info

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  update-repo-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Get version from file
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–≥, –±–µ—Ä—ë–º –≤–µ—Ä—Å–∏—é –∏–∑ —Ç–µ–≥–∞
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION_CLEAN=${VERSION#v}
          else
            # –ï—Å–ª–∏ —ç—Ç–æ main, –±–µ—Ä—ë–º –≤–µ—Ä—Å–∏—é –∏–∑ —Ñ–∞–π–ª–∞ VERSION
            VERSION_CLEAN=$(cat VERSION)
          fi
          echo "version_clean=${VERSION_CLEAN}" >> $GITHUB_OUTPUT
          
      - name: Update repository description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version_clean }}';
            const description = `üå± JXCT 7-–≤-1 –î–∞—Ç—á–∏–∫ –ü–æ—á–≤—ã (v${version}) - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è IoT —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—á–≤—ã –Ω–∞ –±–∞–∑–µ ESP32 —Å Modbus RTU, MQTT –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏`;
            
            await github.rest.repos.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              description: description,
              homepage: 'https://gfermoto.github.io/soil-sensor-7in1/',
              topics: ['esp32', 'iot', 'soil-sensor', 'modbus', 'mqtt', 'arduino', 'platformio', 'agpl-3.0']
            });
            
            console.log(`Repository description updated to: ${description}`); 