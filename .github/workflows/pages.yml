name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '**.md'
      - 'Doxyfile'
      - '.github/workflows/pages.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Debug repository structure
        run: |
          echo "=== Repository structure ==="
          ls -la
          echo "=== Source files ==="
          find src -name "*.cpp" -o -name "*.h" | head -10
          echo "=== Include files ==="
          find include -name "*.h" | head -10
          echo "=== Documentation files ==="
          find docs -name "*.md" | head -10
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install -g markdownlint-cli
          npm install -g markdown-link-check
          
      - name: Lint markdown
        run: |
          echo "=== Linting markdown files ==="
          if [ -f ".markdownlint.yml" ]; then
            markdownlint "**/*.md" --config .markdownlint.yml || echo "Markdown linting completed with warnings"
          else
            markdownlint "**/*.md" || echo "Markdown linting completed with warnings"
          fi
        
      - name: Check links
        run: |
          echo "=== Checking markdown links ==="
          files=$(git ls-files '*.md')
          for f in $files; do 
            if [ -f "$f" ]; then
              echo "Checking links in: $f"
              markdown-link-check -q "$f" || echo "Link check failed for $f, continuing..."
            fi
          done
          
      - name: Install Doxygen
        run: |
          echo "=== Installing Doxygen ==="
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
          doxygen --version
          
      - name: Generate documentation
        run: |
          echo "=== Generating Doxygen documentation ==="
          if [ -f "Doxyfile" ]; then
            echo "Doxyfile found, generating documentation..."
            doxygen Doxyfile
            echo "Doxygen generation completed"
            
            if [ -d "docs/html" ]; then
              echo "‚úÖ docs/html directory created successfully"
              echo "=== Contents of docs/html ==="
              ls -la docs/html/
              echo "=== Number of files generated ==="
              find docs/html -type f | wc -l
            else
              echo "‚ùå docs/html directory not found after Doxygen generation"
              echo "Creating fallback structure..."
              mkdir -p docs/html
            fi
          else
            echo "‚ùå Doxyfile not found, creating basic documentation structure"
            mkdir -p docs/html
          fi
          
      - name: Create main page
        run: |
          echo "=== Creating main page ==="
          if [ ! -d "docs/html" ]; then
            mkdir -p docs/html
          fi
          cat > docs/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>JXCT 7-–≤-1 –î–∞—Ç—á–∏–∫ –ü–æ—á–≤—ã - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f6f8fa; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #24292e; border-bottom: 2px solid #0366d6; padding-bottom: 10px; }
                  .nav { margin: 30px 0; }
                  .nav a { display: inline-block; margin: 10px 15px 10px 0; padding: 12px 20px; background: #0366d6; color: white; text-decoration: none; border-radius: 6px; transition: background 0.3s; }
                  .nav a:hover { background: #0256cc; }
                  .section { margin: 30px 0; }
                  .section h2 { color: #24292e; margin-bottom: 15px; }
                  .section p { line-height: 1.6; color: #586069; }
                  .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                  .feature { padding: 20px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #0366d6; }
                  .feature h3 { margin-top: 0; color: #24292e; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üå± JXCT 7-–≤-1 –î–∞—Ç—á–∏–∫ –ü–æ—á–≤—ã</h1>
                  <p>–£–º–Ω—ã–π –¥–∞—Ç—á–∏–∫ –ø–æ—á–≤—ã —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—á–≤—ã</p>
                  
                  <div class="nav">
                      <a href="index.html">üìñ –ì–ª–∞–≤–Ω–∞—è</a>
                      <a href="classes.html">üìö –ö–ª–∞—Å—Å—ã</a>
                      <a href="files.html">üìÅ –§–∞–π–ª—ã</a>
                      <a href="functions.html">‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏</a>
                      <a href="globals.html">üåê –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</a>
                      <a href="https://github.com/Gfermoto/soil-sensor-7in1">üîó GitHub</a>
                  </div>
                  
                  <div class="section">
                      <h2>üìä –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h2>
                      <div class="features">
                          <div class="feature">
                              <h3>üå°Ô∏è 7 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º –¥–∞—Ç—á–∏–∫–µ</h3>
                              <p>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–ª–∞–∂–Ω–æ—Å—Ç—å, EC, pH, –∞–∑–æ—Ç, —Ñ–æ—Å—Ñ–æ—Ä, –∫–∞–ª–∏–π —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é</p>
                          </div>
                          <div class="feature">
                              <h3>üî¨ –ù–∞—É—á–Ω–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è</h3>
                              <p>–ú–æ–¥–µ–ª—å –ê—Ä—á–∏, —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –ù–µ—Ä–Ω—Å—Ç–∞, FAO 56 –¥–ª—è —Ç–æ—á–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π</p>
                          </div>
                          <div class="feature">
                              <h3>üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
                              <p>–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω, OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV</p>
                          </div>
                          <div class="feature">
                              <h3>üîß ESP32 + PlatformIO</h3>
                              <p>–ú–æ—â–Ω—ã–π –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å WiFi, MQTT, ThingSpeak –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π</p>
                          </div>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</h2>
                      <p>–ü–æ–ª–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤, —Ñ—É–Ω–∫—Ü–∏–π –∏ API.</p>
                      <div class="nav">
                          <a href="classes.html">üìñ –ö–ª–∞—Å—Å—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã</a>
                          <a href="files.html">üìÅ –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã</a>
                          <a href="functions.html">‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏</a>
                          <a href="globals.html">üåê –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</a>
                      </div>
                  </div>
                  
                  <div class="section">
                      <h2>üîó –°—Å—ã–ª–∫–∏</h2>
                      <div class="nav">
                          <a href="https://github.com/Gfermoto/soil-sensor-7in1">üì¶ GitHub Repository</a>
                          <a href="https://github.com/Gfermoto/soil-sensor-7in1/releases">üöÄ Releases</a>
                          <a href="https://github.com/Gfermoto/soil-sensor-7in1/issues">üêõ Issues</a>
                      </div>
                  </div>
                  
                  <div class="section">
                      <p><strong>–í–µ—Ä—Å–∏—è:</strong> 3.4.9 | <strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> ESP32 + PlatformIO | <strong>–õ–∏—Ü–µ–Ω–∑–∏—è:</strong> MIT</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
          echo "‚úÖ Main page created successfully"
          
      - name: Verify documentation structure
        run: |
          echo "=== Verifying documentation structure ==="
          echo "Checking docs/html directory structure:"
          ls -la docs/html/
          if [ -f "docs/html/index.html" ]; then
            echo "‚úÖ Main page exists"
          else
            echo "‚ùå Main page not found"
            exit 1
          fi
          
          echo "=== Final structure ==="
          find docs/html -type f | head -20
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs/html'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 