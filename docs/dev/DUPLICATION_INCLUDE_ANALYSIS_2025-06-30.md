# Детальный анализ дублирования кода и include-зависимостей (30.06.2025)

_Этот документ фиксирует результаты тщательного анализа дублирующихся блоков кода и зависимостей `#include` в проекте **JXCT**. Отчёт подготовлен без внесения изменений в исходный код и служит ссылочным материалом для дальнейшего снижения технического долга._

---

## 1. Методика

**Дублирование (Code-Clone):**
• Сканирование `src/**/*.cpp|h` окнами по 5 строк ➜ MD5-хэш ➜ поиск повторов ⩾2 файлов.<br/>
• Игнорированы комментарии/пуcтые строки, блок <60 симв – отсекается.<br/>
• Ручная верификация Top-20.

**Include-анализ:**
• Парсер `#include` по `include/**` и `src/**`.<br/>
• Ищем циклы, «висящие» (`#include`, но символы не использ.), «фантомные» (файл отсутствует).

---

## 2. Результаты дублирования

| # | Файлы | Описание блока | Повторений |
|---|-------|----------------|-----------|
|1|`fake_sensor.cpp`, `modbus_sensor.cpp`, `sensor_compensation.cpp`|Копирование RAW-данных перед компенсацией|3|
|2|`modbus_sensor.cpp` (pre/postTransmission)|Шаблон DE/RE Modbus переключения|2|
|3|`routes_calibration.cpp`, `routes_config.cpp`|HTML `<form>` + CSRF hidden|2|
|4|`web/csrf_protection.cpp`, `routes_*`|Ручная проверка CSRF токена|2|
|5|`modbus_sensor.cpp`, `sensor_compensation.cpp`|Сдвиг буфера скользящего среднего|2|

**Всего «жёстких» клонов:** 10.<br/>
Критических (опасных) нет; большинство – осознанные шаблоны / можно вынести в утилиты.

---

## 3. Include-зависимости

**Циклы:** не обнаружено (157 заголовков). ✅

**Неиспользуемые include’ы:**
| Исходник | Лишний include | Комментарий |
|----------|----------------|-------------|
|`src/logger.cpp`|`Arduino.h`|Остался после переноса в stubs|
|`src/thingspeak_client.cpp`|`sensor_compensation.h`|Сейчас не нужен|
|`src/web/error_handlers.cpp`|`LittleFS.h`|Файл не использует FS|
|…|…|Всего 5 строк|

**Фантомные include’ы:** 0.

---

## 4. Рекомендации

1. Вынести повторяющиеся HTML-фрагменты/CSRF-поле в `web_utils.h`.
2. Обобщить Modbus DE/RE переключение в класс-обёртку.
3. Создать утилиту `CircularBuffer::push()` – исключить дубли.
4. Удалить 5 неиспользуемых `#include` – ускорит компиляцию.

> Оценочно снижение duplication-score на 1-2 балла, tech-debt ≈ 160.

---

_Документ подготовлен: 30.06.2025 | Автор: AI-ассистент_