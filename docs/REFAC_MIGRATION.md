# Подробный план миграции и рефакторинга JXCT Soil Sensor (ESP32, PlatformIO)

## Приоритет 1: Простые и безопасные улучшения

### 1. Ревизия include/ и src/
**[ВЫПОЛНЕНО] Дублирующие заголовки удалены, структура Config актуализирована, проект собирается.**
- **Описание:** Найти и удалить неиспользуемые функции, привести код к единому стилю.
- **Действия:**
  - Просмотреть все файлы в include/ и src/.
  - Удалить неиспользуемые объявления и определения.
  - Привести имена, отступы, комментарии к единому стилю.
- **Промты:**
  - Какие функции/модули не используются?
  - Есть ли дублирующий или устаревший код?
  - Все ли файлы имеют заголовки и комментарии?

### 2. Обновление README
**[ВЫПОЛНЕНО] Добавлены разделы по API (описание эндпоинта, примеры запросов/ответов) и OTA (пометка о планах).**
- **Описание:** Добавить разделы по OTA, API.
- **Действия:**
  - Добавить описание OTA и API.
  - Привести примеры запросов/ответов для API.
- **Промты:**
  - Есть ли в README примеры работы с API?
  - Описана ли поддержка OTA?

### 3. Doxygen-документация
**[ВЫПОЛНЕНО] Документация успешно сгенерирована, предупреждений по коду нет, все публичные функции и структуры документированы.**
- **Описание:** Сгенерировать и проверить актуальность документации.
- **Действия:**
  - Запустить генерацию Doxygen.
  - Проверить, что все функции и структуры документированы.
- **Промты:**
  - Все ли публичные функции и структуры имеют комментарии?
  - Нет ли устаревших описаний?

### 4. Документирование API
**[ВЫПОЛНЕНО] В README оформлен отдельный раздел с описанием API, примерами запросов/ответов и кодами ошибок.**
- **Описание:** Описать эндпоинты, примеры запросов/ответов, коды ошибок.
- **Действия:**
  - Создать отдельный раздел или файл с документацией API.
  - Привести curl-примеры для каждого эндпоинта.
- **Промты:**
  - Все ли эндпоинты описаны?
  - Есть ли примеры успешных и ошибочных ответов?

### 5. Визуальные индикаторы статуса
**[ВЫПОЛНЕНО]** На странице сервисов реализованы цветные индикаторы, автообновление и подробные статусы всех сервисов.
- **Описание:** Добавить индикаторы (WiFi, MQTT, ThingSpeak, датчик) на главную страницу web.
- **Действия:**
  - Добавить блоки/иконки для статусов.
  - Реализовать обновление статусов через AJAX.
- **Промты:**
  - Все ли статусы отображаются и обновляются?
  - Понятна ли цветовая схема/индикация?

### 6. Оформление форм и сообщений об ошибках
**[ВЫПОЛНЕНО]** Внедрены всплывающие уведомления (toast), унифицированы стили форм и сообщений, оформление стало современным и информативным.
- **Описание:** Сделать оформление форм и сообщений более современным и информативным.
- **План:**
  - Унифицировать стили для всех форм и сообщений.
  - Добавить всплывающие уведомления (toast) для ошибок и успешных действий.
  - Сделать сообщения более заметными и информативными.

### 7. Адаптивность web-интерфейса
**[ВЫПОЛНЕНО]** Интерфейс адаптирован для мобильных устройств: добавлены media-запросы, увеличены кнопки и поля, устранён горизонтальный скролл, все страницы удобны для touch-управления.
- **Описание:** Сделать web-интерфейс удобным для мобильных устройств.
- **План:**
  - Добавить media-запросы в CSS.
  - Проверить отображение на телефоне/планшете.
  - Увеличить размеры кнопок и полей для тач-управления.
  - Устранить горизонтальный скролл.

### 8. Статус публикации ThingSpeak
**[ВЫПОЛНЕНО]** Статус последней публикации и ошибки ThingSpeak отображается в общем списке статусов на странице сервисов, toast-уведомление при ошибке. Дублирующий блок удалён.
- **Описание:** Добавить отображение статуса последней публикации на web.
- **План:**
  - Сохранять результат публикации.
  - Отображать статус на странице сервисов.
  - Всплывающее уведомление при ошибке публикации.

---

## Приоритет 2: Средней сложности

### 9. Локализация строк и параметров
- **Описание:** Вынести все строки и параметры, которые могут меняться, в отдельный файл/секцию.
- **Действия:**
  - Создать файл с переводами/настройками.
  - Использовать переменные вместо жёстко заданных строк.
- **Промты:**
  - Все ли строки вынесены?
  - Легко ли добавить новый язык?

### 10. Экспорт/импорт конфигурации
- **Описание:** Добавить возможность экспорта/импорта настроек через web.
- **Действия:**
  - Реализовать выгрузку и загрузку JSON-файла.
  - Добавить кнопки на страницу настроек.
- **Промты:**
  - Можно ли восстановить конфиг из файла?
  - Есть ли валидация при импорте?

### 11. Настройка QoS для MQTT
- **Описание:** Добавить возможность выбора QoS через web.
- **Действия:**
  - Добавить поле выбора QoS в форму.
  - Сохранять и использовать значение в коде.
- **Промты:**
  - QoS применяется ко всем публикациям?
  - Значение сохраняется после перезагрузки?

### 12. Unit-тесты
- **Описание:** Добавить unit-тесты для функций форматирования и логики работы с конфигом.
- **Действия:**
  - Написать тесты для основных функций.
  - Проверить сборку и запуск тестов.
- **Промты:**
  - Все ли функции покрыты тестами?
  - Нет ли неработающих тестов?

### 13. Версионирование API
- **Описание:** Добавить версию в URL API (например, /api/v1/sensor).
- **Действия:**
  - Изменить роутинг и документацию.
- **Промты:**
  - Старые клиенты не ломаются?
  - Документация обновлена?

---

## Приоритет 3: Сложные и рискованные изменения

### 14. OTA-обновление прошивки
- **Описание:** Реализовать полноценную загрузку и обновление прошивки через web.
- **Действия:**
  - Добавить загрузку файла, прогресс-бар, валидацию.
  - Обработать ошибки и откаты.
- **Промты:**
  - Прошивка не "кирпичит" устройство при ошибке?
  - Есть ли откат на старую версию?

### 15. Обработка ошибок сети (ThingSpeak, MQTT)
- **Описание:** Добавить повторные попытки и информирование пользователя о неудачных публикациях.
- **Действия:**
  - Реализовать логику повторов и отображение статуса.
- **Промты:**
  - Пользователь видит причину ошибки?
  - Нет ли бесконечных циклов попыток?

### 16. История показаний
- **Описание:** Хранить последние N значений показаний в памяти.
- **Действия:**
  - Реализовать кольцевой буфер.
  - Добавить эндпоинт для получения истории.
- **Промты:**
  - Не расходуется ли лишняя память?
  - История очищается при сбросе?

### 17. Рефакторинг крупных файлов
- **Описание:** Разделить большие файлы (например, wifi_manager.cpp) на логические модули.
- **Действия:**
  - Выделить отдельные файлы для web, WiFi, сервисов.
- **Промты:**
  - Нет ли дублирования кода?
  - Все зависимости корректно подключены?

### 18. Руководство пользователя
- **Описание:** Добавить краткое user manual в docs.
- **Действия:**
  - Описать основные сценарии использования.
  - Привести примеры типовых проблем и решений.
- **Промты:**
  - Руководство понятно для новичка?
  - Есть ли FAQ?

---

**План миграции составлен на основе QA-аудита и плана рефакторинга.**