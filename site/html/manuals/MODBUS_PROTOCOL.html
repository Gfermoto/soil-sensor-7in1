<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MODBUS RTU Протокол для JXCT 7-в-1 Датчика Почвы</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .header {
            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -20px -20px 20px -20px;
        }
        .navigation {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .navigation a {
            color: #1976d2;
            text-decoration: none;
            margin-right: 15px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .navigation a:hover {
            background-color: #e3f2fd;
        }
        .content {
            padding: 20px 0;
        }
        h1, h2, h3, h4 {
            color: #2e7d32;
        }
        h1 {
            border-bottom: 3px solid #4caf50;
            padding-bottom: 10px;
        }
        h2 {
            border-bottom: 2px solid #81c784;
            padding-bottom: 5px;
            margin-top: 30px;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #4caf50;
        }
        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .back-link:hover {
            background: #388e3c;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-success { background: #4caf50; color: white; }
        .status-warning { background: #ff9800; color: white; }
        .status-error { background: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MODBUS RTU Протокол для JXCT 7-в-1 Датчика Почвы</h1>
            <p>JXCT 7-в-1 Датчик Почвы - Профессиональная IoT система мониторинга</p>
        </div>
        
        <div class="navigation">
            
        <a href="../../index.html">🏠 Главная</a>
        <a href="USER_GUIDE.html">📋 Руководство</a>
        <a href="TECHNICAL_DOCS.html">🔧 Техническая документация</a>
        <a href="API.html">📡 API</a>
        <a href="../../html/index.html">📚 API документация</a>
    
        </div>
        
        <div class="content">
            <h1>MODBUS RTU Протокол для JXCT 7-в-1 Датчика Почвы</h1>

<strong>Версия:</strong> 3.4.9  
<strong>Дата:</strong> Июнь 2025  
<strong>Автор:</strong> JXCT Development Team

<p>---</p>

<h2>📖 Содержание</h2>

<p>1. <a href="#-обзор">📋 Обзор</a>
2. <a href="#-технические-характеристики">🔧 Технические характеристики</a>
3. <a href="#-карта-регистров">📊 Карта регистров</a>
4. <a href="#-примеры-протокола">🔍 Примеры протокола</a>
5. <a href="#-схема-подключения-esp32">🔧 Схема подключения ESP32</a>
6. <a href="#-оптимизация-производительности">⚡ Оптимизация производительности</a>
7. <a href="#-отладка-и-диагностика">🐛 Отладка и диагностика</a>
8. <a href="#-безопасность">🔒 Безопасность</a>
9. <a href="#-связанная-документация">📋 Связанная документация</a></p>

---

<h2>📋 Обзор</h2>

<p>Датчик JXCT 7-в-1 использует протокол <strong>Modbus RTU</strong> через интерфейс <strong>RS485</strong> для передачи данных измерений почвы. Этот документ содержит полную техническую спецификацию протокола.</p>

<h2>🔧 Технические характеристики</h2>

<h3>Настройки порта (UART2)</h3>
<code></code>`
Параметр            │ Значение
────────────────────┼─────────────
Скорость передачи   │ 9600 baud
Биты данных         │ 8 bits
Четность            │ None (N)
Стоп биты           │ 1 bit
Управление потоком  │ None
Формат              │ 8N1
Интерфейс           │ RS485 полудуплекс
<code></code>`

<h3>Параметры MODBUS</h3>
<code></code>`
Параметр                │ Значение
────────────────────────┼─────────────
Протокол                │ Modbus RTU
Адрес устройства        │ 1 (по умолчанию, настраивается)
Функция чтения          │ 0x03 (Read Holding Registers)
Функция записи          │ 0x06 (Write Single Register)
Таймаут ответа          │ 1000 мс
Максимум попыток        │ 3
Интерфейс               │ RS485 полудуплекс
<code></code>`

<h2>📊 Карта регистров</h2>

<h3>Основные измерения</h3>
<code></code>`
Регистр │ Адрес │ Параметр           │ Формула        │ Единицы │ Диапазон
────────┼───────┼────────────────────┼────────────────┼─────────┼──────────────
0x0006  │ 6     │ pH почвы           │ значение ÷ 100 │ pH      │ 0.00-14.00
0x0012  │ 18    │ Влажность почвы    │ значение ÷ 10  │ %       │ 0.0-100.0
0x0013  │ 19    │ Температура почвы  │ значение ÷ 10  │ °C      │ -10.0-50.0
0x0015  │ 21    │ Электропроводность │ как есть       │ µS/cm   │ 0-20000
0x001E  │ 30    │ Азот (N)           │ как есть       │ мг/кг   │ 0-2000
0x001F  │ 31    │ Фосфор (P)         │ как есть       │ мг/кг   │ 0-2000
0x0020  │ 32    │ Калий (K)          │ как есть       │ мг/кг   │ 0-2000
<code></code>`

<h3>Системные регистры</h3>
<code></code>`
Регистр │ Адрес │ Параметр           │ Формула        │ Единицы │ Доступ
────────┼───────┼────────────────────┼────────────────┼─────────┼────────────
0x0007  │ 7     │ Версия прошивки    │ как есть       │ версия  │ Только чтение
0x0008  │ 8     │ Калибровка         │ как есть       │ флаги   │ Чтение/запись
0x000B  │ 11    │ Статус ошибок      │ как есть       │ флаги   │ Только чтение
0x000C  │ 12    │ Адрес устройства   │ как есть       │ адрес   │ Чтение/запись
<code></code>`

<h2>🔍 Примеры протокола</h2>

<h3>1. Чтение pH почвы (регистр 0x0006)</h3>

<strong>Запрос:</strong>
<code></code>`
Байт │ Hex │ Описание
─────┼─────┼─────────────────────────────
0    │ 01  │ Адрес устройства (1)
1    │ 03  │ Функция (Read Holding Registers)
2    │ 00  │ Адрес регистра (High byte)
3    │ 06  │ Адрес регистра (Low byte) - 0x0006
4    │ 00  │ Количество регистров (High byte)
5    │ 01  │ Количество регистров (Low byte) - 1
6    │ 64  │ CRC16 (High byte)
7    │ 0B  │ CRC16 (Low byte)
<code></code>`

<strong>Ответ:</strong>
<code></code>`
Байт │ Hex │ Описание
─────┼─────┼─────────────────────────────
0    │ 01  │ Адрес устройства (1)
1    │ 03  │ Функция (Read Holding Registers)
2    │ 02  │ Количество байт данных (2)
3    │ 02  │ Значение pH (High byte)
4    │ BC  │ Значение pH (Low byte)
5    │ 38  │ CRC16 (High byte)
6    │ 05  │ CRC16 (Low byte)
<code></code>`

<strong>Расчет значения:</strong>
<code></code>`
Hex значение: 0x02BC = 700 (decimal)
pH = 700 ÷ 100 = 7.00
<code></code>`

<h3>2. Чтение температуры почвы (регистр 0x0013)</h3>

<strong>Запрос:</strong>
<code></code>`
01 03 00 13 00 01 74 0F
<code></code>`

<strong>Ответ:</strong>
<code></code>`
01 03 02 00 ED 78 B8
<code></code>`

<strong>Расчет значения:</strong>
<code></code>`
Hex значение: 0x00ED = 237 (decimal)
Температура = 237 ÷ 10 = 23.7°C
<code></code>`

<h3>3. Чтение нескольких регистров (NPK)</h3>

<strong>Запрос (регистры 0x001E-0x0020):</strong>
<code></code>`
01 03 00 1E 00 03 65 CC
<code></code>`

<strong>Ответ:</strong>
<code></code>`
01 03 06 01 5E 01 F3 03 D6 XX XX
<code></code>`

<strong>Расчет значений:</strong>
<code></code>`
Азот (N):    0x015E = 350 мг/кг
Фосфор (P):  0x01F3 = 499 мг/кг  
Калий (K):   0x03D6 = 982 мг/кг
<code></code>`

<h2>🔧 Схема подключения ESP32</h2>

<h3>Физическое подключение</h3>

<p>#### RS-485 интерфейс<ul>
<li>Используется трансивер SP3485E</li>
</ul><li>Скорость передачи: до 10 Mbps</li><ul>
<li>Защита от ESD: ±15kV HBM</li>
</ul><li>Питание: 3.3V (оптимально для ESP32)</li></p>

#### Подключение SP3485E
<code></code>`
ESP32 GPIO   │ SP3485E Pin │ Функция
─────────────┼────────────┼──────────────────────────────────
GPIO16       │ RO         │ Receive Output (к UART RX)
GPIO17       │ DI         │ Data Input (от UART TX)
GPIO4        │ DE         │ Driver Enable (управление передатчиком)
GPIO5        │ RE         │ Receiver Enable (управление приемником)
GND          │ GND        │ Общий провод
3.3V         │ VCC        │ Питание модуля
<code></code>`

<p>#### Важность раздельного управления DE и RE<ul>
<li><strong>DE (Driver Enable)</strong> - управляет передатчиком:</li>
</ul>  - HIGH: передатчик активен (для отправки данных)
  - LOW: передатчик в высокоимпедансном состоянии<ul>
<li><strong>RE (Receiver Enable)</strong> - управляет приемником:</li>
</ul>  - HIGH: приемник отключен (во время передачи)
  - LOW: приемник активен (для приема данных)</p>

Раздельное управление этими пинами обеспечивает:
1. Более точный контроль над временем переключения
2. Возможность тонкой настройки задержек
3. Предотвращение коллизий на шине RS-485
4. Улучшенную помехозащищенность

<p>#### Временные диаграммы переключения</p>

<code></code>`
DE ──┐          ┌────────┐          ┌────────
     │          │        │          │
     └──────────┘        └──────────┘

<p>RE ──┐          ┌────────┐          ┌────────
     │          │        │          │
     └──────────┘        └──────────┘
     ├─ прием ──┤├─ передача ─┤├─ прием ──┤
     
     │◄─ 50µs ─►│          │◄─ 50µs ─►│
<code></code>`</p>

Задержки переключения:<ul>
<li>50 микросекунд перед передачей (preTransmission)</li>
</ul><li>50 микросекунд после передачи (postTransmission)</li>

<h3>Подключение к датчику JXCT</h3>
<code></code>`
Transceiver  │ JXCT Sensor │ Цвет провода │ Функция
─────────────┼─────────────┼──────────────┼─────────────────
A+ Terminal  │ A+          │ Желтый       │ RS485 Data+
B- Terminal  │ B-          │ Синий        │ RS485 Data-
<code></code>`

<h3>Питание датчика (отдельное!)</h3>
<code></code>`
Источник     │ JXCT Sensor │ Цвет провода │ Функция
─────────────┼─────────────┼──────────────┼─────────────────
12-24V DC+   │ VCC         │ Красный      │ Питание датчика
GND          │ GND         │ Черный       │ Общий минус
<code></code>`

<h2>⚙️ Реализация в коде ESP32</h2>

<h3>Инициализация UART и SP3485E</h3>

<code></code>`cpp
void setupModbus() {
    // Настройка UART2 для Modbus
    Serial2.begin(9600, SERIAL_8N1, MODBUS_RX_PIN, MODBUS_TX_PIN);
    
    // Настройка пинов SP3485E
    pinMode(MODBUS_DE_PIN, OUTPUT);    // GPIO4
    pinMode(MODBUS_RE_PIN, OUTPUT);    // GPIO5
    digitalWrite(MODBUS_DE_PIN, LOW);  // Передатчик выключен
    digitalWrite(MODBUS_RE_PIN, LOW);  // Приемник включен
    
    // Инициализация Modbus
    node.begin(SENSOR_ID, Serial2);
    
    // Настройка обработчиков переключения режима
    node.preTransmission(preTransmission);   // Перед передачей
    node.postTransmission(postTransmission); // После передачи
}

<p>// Управление направлением передачи SP3485E
void preTransmission() {
    digitalWrite(MODBUS_DE_PIN, HIGH);  // Режим передачи
    delayMicroseconds(50);
}</p>

void postTransmission() {
    delayMicroseconds(50);
    digitalWrite(MODBUS_RE_PIN, LOW);   // Режим приема
}
<code></code>`

<h3>Чтение данных</h3>
<code></code>`cpp
void readSensorData() {
    // Чтение pH
    uint8_t result = modbus.readHoldingRegisters(0x0006, 1);
    if (result == modbus.ku8MBSuccess) {
        uint16_t ph_raw = modbus.getResponseBuffer(0);
        float ph = ph_raw / 100.0;
    }
    
    // Чтение температуры
    result = modbus.readHoldingRegisters(0x0013, 1);
    if (result == modbus.ku8MBSuccess) {
        uint16_t temp_raw = modbus.getResponseBuffer(0);
        float temperature = temp_raw / 10.0;
    }
    
    // Чтение NPK (3 регистра за один запрос)
    result = modbus.readHoldingRegisters(0x001E, 3);
    if (result == modbus.ku8MBSuccess) {
        uint16_t nitrogen = modbus.getResponseBuffer(0);
        uint16_t phosphorus = modbus.getResponseBuffer(1);
        uint16_t potassium = modbus.getResponseBuffer(2);
    }
}
<code></code>`

<h2>🛠️ Диагностика и отладка</h2>

<h3>Коды ошибок ModbusMaster</h3>
<code></code>`
Код │ Константа              │ Описание
────┼────────────────────────┼─────────────────────────────
0   │ ku8MBSuccess           │ Успешное выполнение
1   │ ku8MBIllegalFunction   │ Недопустимая функция
2   │ ku8MBIllegalDataAddress│ Недопустимый адрес данных
3   │ ku8MBIllegalDataValue  │ Недопустимое значение данных
4   │ ku8MBSlaveDeviceFailure│ Ошибка ведомого устройства
224 │ ku8MBInvalidSlaveID    │ Недопустимый ID устройства
225 │ ku8MBInvalidFunction   │ Недопустимая функция
226 │ ku8MBResponseTimedOut  │ Таймаут ответа
227 │ ku8MBInvalidCRC        │ Ошибка CRC
<code></code>`

<h3>Проверка связи</h3>
<code></code>`cpp
bool testModbusConnection() {
    logSystem("Тест связи с датчиком JXCT...");
    
    // Попытка чтения версии прошивки
    uint8_t result = modbus.readHoldingRegisters(0x0007, 1);
    
    if (result == modbus.ku8MBSuccess) {
        uint16_t version = modbus.getResponseBuffer(0);
        logSuccess("Датчик найден! Версия прошивки: %d.%d", 
                  (version >> 8) & 0xFF, version & 0xFF);
        return true;
    } else {
        logError("Ошибка связи с датчиком: %d", result);
        return false;
    }
}
<code></code>`

<h2>🔍 Расчет CRC16</h2>

<p>MODBUS RTU использует CRC16 с полиномом 0xA001:</p>

<code></code>`cpp
uint16_t calculateCRC16(uint8_t* data, size_t length) {
    uint16_t crc = 0xFFFF;
    
    for (size_t i = 0; i < length; i++) {
        crc ^= (uint16_t)data[i];
        for (int j = 0; j < 8; j++) {
            if (crc & 0x0001) {
                crc = (crc >> 1) ^ 0xA001;
            } else {
                crc = crc >> 1;
            }
        }
    }
    
    return crc;
}
<code></code>`

<h2>🚨 Типичные проблемы и решения</h2>

<h3>1. Таймаут ответа (ku8MBResponseTimedOut)</h3>
<strong>Причины:</strong><ul>
<li>Неправильное подключение A+/B-</li>
</ul><li>Неисправность кабеля RS485</li><ul>
<li>Неправильный адрес устройства</li>
</ul><li>Проблемы с питанием датчика</li>

<strong>Решение:</strong>
<code></code>`cpp
// Проверка подключения
if (!testModbusConnection()) {
    logError("Проверьте подключение RS485 и питание датчика");
}
<code></code>`

<h3>2. Ошибка CRC (ku8MBInvalidCRC)</h3>
<strong>Причины:</strong><ul>
<li>Помехи в линии RS485</li>
</ul><li>Плохое качество кабеля</li><ul>
<li>Неправильная скорость передачи</li>
</ul>
<strong>Решение:</strong><ul>
<li>Использовать экранированный кабель</li>
</ul><li>Проверить заземление</li><ul>
<li>Добавить терминальные резисторы (120 Ом)</li>
</ul>
<h3>3. Недопустимый адрес данных (ku8MBIllegalDataAddress)</h3>
<strong>Причины:</strong><ul>
<li>Запрос несуществующего регистра</li>
</ul><li>Различия в версиях прошивки датчика</li>

<strong>Решение:</strong>
<code></code>`cpp
// Проверка поддерживаемых регистров
const uint16_t test_registers[] = {0x0006, 0x0012, 0x0013, 0x0015};
for (int i = 0; i < 4; i++) {
    uint8_t result = modbus.readHoldingRegisters(test_registers[i], 1);
    if (result != modbus.ku8MBSuccess) {
        logWarn("Регистр 0x%04X недоступен: %d", test_registers[i], result);
    }
}
<code></code>`

<h2>📐 Валидация данных</h2>

<h3>Допустимые диапазоны</h3>
<code></code>`cpp
bool validateSensorData(SensorData& data) {
    // Температура: -10°C до +50°C
    if (data.temperature < -10.0 || data.temperature > 50.0) return false;
    
    // Влажность: 0% до 100%
    if (data.humidity < 0.0 || data.humidity > 100.0) return false;
    
    // pH: 0 до 14
    if (data.ph < 0.0 || data.ph > 14.0) return false;
    
    // EC: 0 до 20000 µS/cm
    if (data.ec < 0.0 || data.ec > 20000.0) return false;
    
    // NPK: 0 до 2000 мг/кг
    if (data.nitrogen < 0.0 || data.nitrogen > 2000.0) return false;
    if (data.phosphorus < 0.0 || data.phosphorus > 2000.0) return false;
    if (data.potassium < 0.0 || data.potassium > 2000.0) return false;
    
    return true;
}
<code></code>`

<h2>📋 Справочная информация</h2>

<h3>Документация производителя</h3><ul>
<li><strong>Производитель:</strong> JXCT (Jingxun Changtong)</li>
</ul><li><strong>Модель:</strong> JXBS-3001 7-in-1 Soil Sensor</li><ul>
<li><strong>Интерфейс:</strong> RS485 Modbus RTU</li>
</ul><li><strong>Питание:</strong> 12-24V DC</li><ul>
<li><strong>Протокол:</strong> Modbus RTU</li>
</ul>
<h3>Связанные файлы проекта</h3><ul>
<li><code>src/modbus_sensor.h</code> - Определения констант и структур</li>
</ul><li><code>src/modbus_sensor.cpp</code> - Реализация функций</li><ul>
<li><code>include/jxct_config_vars.h</code> - Настройки пинов</li>
</ul><li><code>docs/API.md</code> - REST API документация</li>

<p>---</p>

<em>Документ обновлен для версии JXCT v2.4.3</em>

<h2>📞 Поддержка</h2>

<h3>💬 Связь с разработчиками</h3><ul>
<li><strong>Telegram:</strong> <a href="https://t.me/Gfermoto">@Gfermoto</a></li>
</ul><li><strong>GitHub Issues:</strong> <a href="https://github.com/Gfermoto/soil-sensor-7in1/issues">Сообщить о проблеме</a></li><ul>
<li><strong>Документация:</strong> <a href="https://gfermoto.github.io/soil-sensor-7in1/">GitHub Pages</a></li>
</ul>
<h3>📚 Дополнительные ресурсы</h3><ul>
<li><a href="USER_GUIDE.md">Руководство пользователя</a></li>
</ul><li><a href="TECHNICAL_DOCS.md">Техническая документация</a></li><ul>
<li><a href="AGRO_RECOMMENDATIONS.md">Агрономические рекомендации</a></li>
</ul><li><a href="COMPENSATION_GUIDE.md">Руководство по компенсации</a></li><ul>
<li><a href="API.md">API документация</a></li>
</ul><li><a href="CONFIG_MANAGEMENT.md">Управление конфигурацией</a></li><ul>
<li><a href="WIRING_DIAGRAM.md">Схема подключения</a></li>
</ul><li><a href="VERSION_MANAGEMENT.md">Управление версиями</a></li>

<h3>🔗 Полезные ссылки</h3>
<ul>
<li><a href="https://github.com/Gfermoto/soil-sensor-7in1">🌱 GitHub репозиторий</a> - Исходный код проекта</li>
</ul><li><a href="../dev/QA_REFACTORING_PLAN_2025H2.md">📋 План рефакторинга</a> - Планы развития на 2025</li><ul>
<li><a href="../dev/TECH_DEBT_REPORT_2025-06.md">📊 Отчет о техническом долге</a> - Анализ технических проблем</li>
</ul><li><a href="../dev/ARCH_OVERALL.md">🏗️ Архитектура системы</a> - Общая архитектура проекта </li>
        </div>
        
        <a href="../../index.html" class="back-link">← Вернуться на главную</a>
    </div>
</body>
</html>