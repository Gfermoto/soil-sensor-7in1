;
; JXCT Soil Sensor v2.4.3 - Professional IoT Solution
; Author: JXCT Development Team  
; Version: 2.4.3
; Last Updated: June 2025
; License: MIT
;

; Default environment for development
[platformio]
default_envs = esp32dev

; =============================================================================
; üõ†Ô∏è DEVELOPMENT CONFIGURATION - –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏
; =============================================================================
[env:esp32dev]
platform = espressif32 @ ^6.3.0
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600
board_build.partitions = min_spiffs.csv
test_build_src = yes
monitor_encoding = utf-8

; Project metadata and development flags
build_flags = 
  -D JXCT_BUILD_DATE='"2025-06-11"'
  -D MQTT_MAX_PACKET_SIZE=1024
  -D MQTT_KEEPALIVE=60
  -D MQTT_SOCKET_TIMEOUT=15
  -D LED_BUILTIN=2
  -D BOOT_BUTTON=0
  -D DEBUG_MODE         ; –û—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ä–µ–∂–∏–º
  -D INFO_MODE          ; –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  ; –ë–∞–∑–æ–≤—ã–µ FreeRTOS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  -D ARDUINO_LOOP_STACK_SIZE=6144  ; –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  -D CONFIG_FREERTOS_HZ=1000       ; –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–∞–π–º–∏–Ω–≥–∞
  -std=gnu++17
  -fstack-protector-all
  -D CONFIG_HEAP_POISONING_LIGHT=1
  -D CONFIG_STACK_CHECK_MODE=2

; Core libraries
lib_deps =
  knolleary/PubSubClient @ ^2.8
  bblanchon/ArduinoJson @ ^6.21.4
  4-20ma/ModbusMaster @ ^2.0.1
  arduino-libraries/NTPClient @ ^3.2.1
  mathworks/ThingSpeak @ ^2.1.1

; Debugging tools
monitor_filters = colorize, esp32_exception_decoder

; –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç C++11, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è C++17
build_unflags =
  -std=gnu++11

; –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ 240 –ú–ì—Ü
board_build.f_cpu = 240000000L

extra_scripts = pre:scripts/auto_version.py

; =============================================================================
; üè≠ PRODUCTION CONFIGURATION - –°—Ç–∞–±–∏–ª—å–Ω–∞—è production –≤–µ—Ä—Å–∏—è
; =============================================================================
[env:esp32dev-production]
extends = env:esp32dev
build_type = release
build_flags = 
  -D JXCT_BUILD_DATE='"2025-06-11"'
  -D MQTT_MAX_PACKET_SIZE=1024
  -D MQTT_KEEPALIVE=60
  -D MQTT_SOCKET_TIMEOUT=15
  -D LED_BUILTIN=2
  -D BOOT_BUTTON=0
  -D NDEBUG
  
  ; ‚ö° –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ v2.3.0 - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞
  -Os                    ; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ (–≤–º–µ—Å—Ç–æ -O3)
  -ffast-math           ; –ë—ã—Å—Ç—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π
  -funroll-loops        ; –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Ü–∏–∫–ª–æ–≤
  -fomit-frame-pointer  ; –£–±–∏—Ä–∞–µ–º frame pointer
  -finline-functions    ; –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∏–Ω–ª–∞–π–Ω–∏–Ω–≥
  -ffunction-sections   ; –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
  -fdata-sections       ; –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  
  ; üîã –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—É–º–µ—Ä–µ–Ω–Ω—ã–µ)
  -D CORE_DEBUG_LEVEL=1           ; –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π debug Arduino Core
  
  ; üöÄ FreeRTOS –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ)
  -D ARDUINO_LOOP_STACK_SIZE=6144                    ; –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Å—Ç–µ–∫ (–∫–∞–∫ –≤ dev)
  -D CONFIG_FREERTOS_HZ=1000                         ; –í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ç–∞–π–º–∏–Ω–≥–∞
  -D CONFIG_FREERTOS_VTASKLIST_INCLUDE_COREID=0      ; –û—Ç–∫–ª—é—á–∏—Ç—å Core ID 
  -D CONFIG_FREERTOS_GENERATE_RUN_TIME_STATS=0       ; –û—Ç–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  -D CONFIG_FREERTOS_CHECK_STACKOVERFLOW=2           ; –í–ö–õ–Æ–ß–ò–¢–¨ –ø—Ä–æ–≤–µ—Ä–∫–∏ stack
  -D CONFIG_FREERTOS_HEAP_TASK_TRACKING=0            ; –û—Ç–∫–ª—é—á–∏—Ç—å heap tracking
  -std=gnu++17
  -fstack-protector-all
  -D CONFIG_HEAP_POISONING_LIGHT=1
  -D CONFIG_STACK_CHECK_MODE=2
  -D NO_ANSI_COLORS
  -D NO_EMOJI

build_unflags = 
  -fno-exceptions       ; –£–±–∏—Ä–∞–µ–º overhead –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
  -std=gnu++11

; –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏ –ª–∏–Ω–∫–µ—Ä–∞
board_build.ldflags = 
  -Wl,--gc-sections      ; –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–µ–∫—Ü–∏–π
  -Wl,-O2               ; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–∏–Ω–∫–µ—Ä–∞
  -Wl,--relax           ; –õ–∏–Ω–∫–µ—Ä–Ω–∞—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏—è 

; –£–±–∏—Ä–∞–µ–º DEBUG_MODE –∏–∑ production: –æ–Ω –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è, —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –Ω–∏–≥–¥–µ –Ω–µ –≤–ø–∏—Å–∞–Ω

; –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
board_build.f_cpu = 240000000L

extra_scripts = pre:scripts/auto_version.py

monitor_encoding = utf-8

; =============================================================================
; üñ•Ô∏è NATIVE TEST CONFIGURATION (PC) - –±—ã—Å—Ç—Ä—ã–µ unit-—Ç–µ—Å—Ç—ã –±–µ–∑ –ø—Ä–æ—à–∏–≤–∫–∏
; =============================================================================
[env:native]
platform = native
build_flags = -std=c++17 -I test/stubs -I test

test_build_src = yes
build_src_filter = +<validation_utils.cpp> +<sensor_compensation.cpp> +<jxct_format_utils.cpp> -<*>

; –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å –æ—Ç—á—ë—Ç–∞–º–∏
[env:native-comprehensive]
platform = native
build_flags = -std=c++17 -I test/stubs -I test -DCOMPREHENSIVE_TESTING

test_build_src = yes
build_src_filter = +<validation_utils.cpp> +<sensor_compensation.cpp> +<jxct_format_utils.cpp> -<*>

; –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞
[env:native-coverage]
platform = native
build_flags = 
  -std=c++17 
  -I test/stubs 
  -I test
  --coverage
  -fprofile-arcs
  -ftest-coverage
  -O0
  -g

build_unflags = -Os -O2

test_build_src = yes
build_src_filter = +<validation_utils.cpp> +<sensor_compensation.cpp> +<jxct_format_utils.cpp> -<*> 

[env:esp32dev-asan]
extends = env:esp32dev
build_flags =
  -fsanitize=address 