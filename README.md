# JXCT Soil Sensor v2.4.3

IoT система мониторинга почвы на ESP32 с датчиком JXCT 7-в-1 (Modbus RTU).

## 🚀 **Возможности v2.4.3 (Максимальная отзывчивость):**  
- **Сверхбыстрый опрос:** Чтение датчика каждую секунду (вместо 30 секунд)
- **Частые обновления:** MQTT публикация каждую минуту (вместо 5 минут)  
- **Быстрая реакция:** Минимальные пороги дельта-фильтра по умолчанию
- **Минимальное сглаживание:** Окно скользящего среднего 5 измерений
- **Отзывчивость:** Фильтр выбросов отключен для максимальной чувствительности

## 🔧 **Готовность к OTA v2.5.0:**
- ✅ **Память:** 913KB Flash (46.5%) - стабильное использование
- ✅ **Стабильность:** Надежная архитектура
- ✅ **Архитектура:** Константы централизованы, модульность улучшена

## 🌱 Что измеряет
- 🌡️ **Температура почвы** (-10°C до +50°C) 
- 💧 **Влажность почвы** (0-100%)
- ⚡ **Электропроводность (EC)** (0-20,000 µS/cm)
- ⚗️ **pH уровень** (0-14)
- 🔴 **Азот (N)** (0-2000 мг/кг)
- 🟡 **Фосфор (P)** (0-2000 мг/кг)
- 🔵 **Калий (K)** (0-2000 мг/кг)

## ⚡ Возможности
- **WiFi подключение** - автоматическое переключение AP/STA режимов
- **Веб-интерфейс** - настройка и мониторинг через браузер
- **MQTT публикация** - отправка данных в брокер каждую минуту (по умолчанию) с минимальной дельта-фильтрацией
- **Home Assistant** - автоматическое добавление датчиков
- **ThingSpeak** - загрузка в облако с настраиваемыми интервалами
- **REST API** - JSON endpoints для интеграций
- **Фильтрация данных** - скользящее среднее, фильтр выбросов >2σ

## 🔧 Оборудование
- **ESP32-DevKit** (любой с 4MB Flash, протестировано на ESP32-WROOM-32)
- **Датчик JXCT 7-в-1 Soil Sensor** (pH, влажность, температура, EC, NPK)
- **MAX485 модуль** для конвертации RS485 (TTL ↔ RS485)
- **Провода** для подключения (рекомендуется экранированный кабель для RS485)

## 📦 Схема подключения

### 🔌 **Подключение MAX485 к ESP32:**
```
ESP32 GPIO   →   MAX485 Module   →   Функция
──────────────────────────────────────────────
GPIO16 (RX)  →   RO               →   Прием данных
GPIO17 (TX)  →   DI               →   Передача данных  
GPIO4        →   DE               →   Управление передачей
GPIO5        →   RE               →   Управление передачей
3.3V         →   VCC              →   Питание модуля
GND          →   GND              →   Общий провод
```

### 📡 **Подключение JXCT датчика к MAX485:**
```
MAX485       →   JXCT Sensor      →   Назначение
──────────────────────────────────────────────
A+ (Terminal) →   A+ (Yellow)     →   RS485 Data+
B- (Terminal) →   B- (Blue)       →   RS485 Data-
─────────────────────────────────────────────
Отдельное питание для датчика:
12-24V DC    →   Red (Power+)     →   Питание датчика
GND          →   Black (Power-)   →   Общий минус
```

### ⚡ **Полная схема подключения:**
```
    ┌─────────────┐    ┌─────────────┐    ┌──────────────┐
    │   ESP32     │    │   MAX485    │    │  JXCT 7-in-1 │
    │   DevKit    │◄──►│   Module    │◄──►│   Sensor     │
    │   (3.3V)    │    │   (3.3V)    │    │   (12-24V)   │
    └─────┬───────┘    └─────────────┘    └──────┬───────┘
          │                                       │
          │            ┌─────────────┐           │
          │            │   DC-DC     │           │
          └────────────┤ 12V → 5V    ├───────────┘
                       │ Converter   │
                       └─────┬───────┘
                             │
                       ┌─────▼───────┐
                       │   12-24V    │
                       │   Power     │
                       │   Supply    │
                       └─────────────┘
                       
Общая земля (GND) объединена для всех устройств
```

## 📋 **Детали MODBUS RTU протокола:**

### 🔧 **Настройки порта (UART2):**
- **Скорость:** 9600 baud
- **Биты данных:** 8
- **Четность:** None (N)
- **Стоп биты:** 1
- **Управление потоком:** None
- **Формат:** 8N1

### 📬 **Параметры MODBUS:**
- **Протокол:** Modbus RTU
- **Адрес устройства:** 1 (по умолчанию)
- **Функция:** 0x03 (Read Holding Registers)
- **Интерфейс:** RS485 полудуплекс
- **Таймаут ответа:** 1000 мс
- **Максимум попыток:** 3

### 📊 **Карта регистров JXCT датчика:**
```
Регистр  │ Адрес  │ Параметр           │ Формула        │ Единицы
─────────┼────────┼────────────────────┼────────────────┼─────────
0x0006   │ 6      │ pH почвы           │ значение ÷ 100 │ pH
0x0012   │ 18     │ Влажность почвы    │ значение ÷ 10  │ %
0x0013   │ 19     │ Температура почвы  │ значение ÷ 10  │ °C
0x0015   │ 21     │ Электропроводность │ как есть       │ µS/cm
0x001E   │ 30     │ Азот (N)           │ как есть       │ мг/кг
0x001F   │ 31     │ Фосфор (P)         │ как есть       │ мг/кг
0x0020   │ 32     │ Калий (K)          │ как есть       │ мг/кг
0x0007   │ 7      │ Версия прошивки    │ как есть       │ версия
0x000B   │ 11     │ Статус ошибок      │ как есть       │ флаги
```

### 🔍 **Пример MODBUS запроса (чтение pH):**
```
Запрос:  01 03 00 06 00 01 64 0B
         │  │  │     │  │  │  └─ CRC16 Low
         │  │  │     │  │  └──── CRC16 High
         │  │  │     │  └─────── Количество регистров (1)
         │  │  │     └────────── Адрес регистра High (0x00)
         │  │  └──────────────── Адрес регистра Low (0x06)
         │  └─────────────────── Функция (0x03 - Read Holding)
         └────────────────────── Адрес устройства (1)

Ответ:   01 03 02 02 BC 38 05
         │  │  │  │     │  └──── CRC16 Low
         │  │  │  │     └─────── CRC16 High
         │  │  │  └───────────── Значение pH Low (0xBC = 188)
         │  │  └──────────────── Значение pH High (0x02 = 2)
         │  └─────────────────── Количество байт данных (2)
         └────────────────────── Адрес устройства (1)
         
pH = (0x02BC = 700) ÷ 100 = 7.00
```

## 🚀 Быстрый старт

### 1. Прошивка
```bash
git clone https://github.com/Gfermoto/JXCT
cd JXCT
pio run -t upload
```

### 2. Первоначальная настройка
1. ESP32 создаст WiFi сеть `jxct-XXXXXX` с паролем `12345678`
2. Подключитесь и откройте `http://192.168.4.1`
3. Настройте WiFi, MQTT, ThingSpeak
4. Нажмите "Сохранить настройки"

### 3. Использование
После подключения к домашней WiFi:
- **Основные настройки:** `http://[IP-адрес]/`  
- **Мониторинг данных:** `http://[IP-адрес]/readings`
- **Настройка интервалов:** `http://[IP-адрес]/intervals`
- **Управление конфигурацией:** `http://[IP-адрес]/config_manager`
- **Сервисная информация:** `http://[IP-адрес]/service`
- **API данных:** `http://[IP-адрес]/api/sensor`

## 🔌 Интеграция с Home Assistant

Добавьте в `configuration.yaml`:
```yaml
mqtt:
  sensor:
    - name: "Soil Temperature"  
      state_topic: "homeassistant/sensor/jxct_soil/temperature/state"
      unit_of_measurement: "°C"
      device_class: "temperature"
    - name: "Soil Humidity"
      state_topic: "homeassistant/sensor/jxct_soil/humidity/state"  
      unit_of_measurement: "%"
      device_class: "humidity"
    - name: "Soil pH"
      state_topic: "homeassistant/sensor/jxct_soil/ph/state"
      unit_of_measurement: "pH"
    - name: "Soil EC"
      state_topic: "homeassistant/sensor/jxct_soil/ec/state"
      unit_of_measurement: "µS/cm"
    - name: "Soil Nitrogen"
      state_topic: "homeassistant/sensor/jxct_soil/nitrogen/state"
      unit_of_measurement: "mg/kg"
    - name: "Soil Phosphorus"  
      state_topic: "homeassistant/sensor/jxct_soil/phosphorus/state"
      unit_of_measurement: "mg/kg"
    - name: "Soil Potassium"
      state_topic: "homeassistant/sensor/jxct_soil/potassium/state"
      unit_of_measurement: "mg/kg"
```

Или включите **MQTT Discovery** в настройках - датчики добавятся автоматически.

## 📊 API

### Получить данные датчика
```bash
curl http://192.168.1.100/api/sensor
```

```json
{
  "temperature": 23.7,
  "humidity": 54.4,
  "ec": 1200,
  "ph": 6.8,
  "nitrogen": 15,
  "phosphorus": 8,
  "potassium": 20,
  "timestamp": 1717920000,
  "valid": true
}
```

### Системная информация
```bash
curl http://192.168.1.100/health
```

### Статус сервисов
```bash
curl http://192.168.1.100/service_status
```

Полная документация API: [`docs/API.md`](docs/API.md)

## 🛠️ Разработка

**Требования:**
- PlatformIO Core или PlatformIO IDE
- ESP32 Arduino Framework

**Конфигурации сборки:**
- `esp32dev` - разработка с полными логами
- `esp32dev-production` - продакшн с оптимизацией

```bash
# Разработка
pio run -e esp32dev -t upload -t monitor

# Продакшн  
pio run -e esp32dev-production -t upload
```

## 📈 Производительность v2.4.3 (Режим максимальной отзывчивости)
- **Flash:** 913KB (46.5%) - стабильное использование
- **RAM:** 53KB (16.4%) - оптимальное потребление памяти
- **Частота опроса:** 1 Hz (каждую секунду) - интенсивная нагрузка на Modbus RTU
- **Свободно для OTA:** 1.0MB+ (достаточно для partition + обновление)
- **Стабильность:** Надежная архитектура с частым опросом датчика
- ⚠️ **Внимание:** Опрос каждую секунду создает повышенную нагрузку на RS485 интерфейс

## 🔧 Фильтрация и обработка данных

### 📊 **Скользящее среднее (минимальная фильтрация по умолчанию):**
- Размер окна: 5 измерений (по умолчанию, минимум для быстрой реакции)
- Алгоритм: среднее арифметическое (по умолчанию)
- Фильтр выбросов >2σ: отключен (по умолчанию)
- Буферы для каждого параметра

### 🎯 **Дельта-фильтр (настроен на минимум по умолчанию):**
- Температура: ±0.1°C (по умолчанию, было 0.5°C)  
- Влажность: ±0.5% (по умолчанию, было 2.0%)
- pH: ±0.01 (по умолчанию, было 0.1)
- EC: ±10 µS/cm (по умолчанию, было 50 µS/cm)
- NPK: ±1 мг/кг (по умолчанию, было 5 мг/кг)

### 🔍 **Фильтр выбросов >2σ:**
- Автоматическое отбрасывание аномальных измерений
- Статистический анализ по последним 10 точкам
- Настраиваемое включение/отключение

## 🗓️ План развития
См. [`docs/DEVELOPMENT_ROADMAP_2025.md`](docs/DEVELOPMENT_ROADMAP_2025.md)

## 🐞 Устранение неполадок

### Проблемы с MODBUS:
1. **Нет данных с датчика:**
   - Проверьте подключение A+/B- к датчику
   - Убедитесь в правильности питания датчика (12-24V)
   - Проверьте адрес устройства (по умолчанию 1)

2. **Ошибки CRC:**
   - Проверьте качество RS485 кабеля
   - Убедитесь в отсутствии помех
   - Проверьте заземление

3. **Таймауты:**
   - Проверьте настройки MAX485 (DE/RE пины)
   - Убедитесь в правильной скорости (9600 baud)

### Проблемы с WiFi:
1. **Не подключается к сети:**
   - Сбросьте настройки (10 сек кнопка RESET)
   - Проверьте SSID/пароль
   - Убедитесь в зоне покрытия

## 📄 Лицензия
MIT License 